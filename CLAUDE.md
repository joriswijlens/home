# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a self-hosted home automation infrastructure project managing multiple Raspberry Pi servers using a planetary naming convention (Mars, Jupiter, Venus, Saturn). The system is built on Infrastructure-as-Code principles using Ansible and Docker, with a focus on privacy, zero emissions, and maintainability.

## Architecture

### Planetary Server Infrastructure

- **Mars**: Primary home automation server (Ubuntu, 16GB RAM, 1TB SSD)
  - Runs Home Assistant, MQTT, Zigbee2MQTT, Z-Wave JS UI
  - Main service hub at `/infrastructure/mars/`

- **Jupiter**: Open cloud services (Ubuntu, 16GB RAM, 1TB SSD)
  - Inventory group: `[opencloud]`
  - At `/infrastructure/jupiter/`

- **Venus**: AI processing node (Debian Bookworm, Raspberry Pi 3, 1GB RAM)
  - Inventory group: `[ai-nodes]`
  - At `/infrastructure/venus/`

- **Saturn**: WireGuard VPN server (Debian Bookworm)
  - Inventory group: `[wireguard]`
  - At `/infrastructure/saturn/`

### Service Configuration Pattern

Services are in `/services/` with this structure:
```
service-name/
├── service.yml          # Defines config_dir (e.g., "config", "data", "store")
└── <config_dir>/        # Actual configuration files
```

Ansible reads `service.yml` to determine which directory to sync to remote `/opt/smartworkx/volumes/<service>/<config_dir>/`.

### Volume Strategy

- **Production**: `VOLUMES_DIR=/opt/smartworkx/volumes` (on remote Raspberry Pi)
- **Development**: `../volumes/` (local, gitignored)
- Use `docker-compose.dev.yml` for local overrides (automatically loaded)

## Common Commands

### Initial Server Setup

1. **Bootstrap Ansible user on new Raspberry Pi**:
   ```bash
   scp infrastructure/scripts/setup-ansible-user.sh joris@<hostname>.local:~/
   ssh joris@<hostname>.local
   ./setup-ansible-user.sh
   ```

2. **Setup Docker on host**:
   ```bash
   cd infrastructure/<planet>/ansible/
   ansible-playbook -i inventory.ini setup-host-playbook.yml
   ```

### Mars (Home Automation) Deployment

**ALWAYS backup before deploying**:
```bash
cd infrastructure/mars/ansible/
ansible-playbook -i inventory.ini backup_remote_data.yml
```

**Deploy configuration changes**:
```bash
cd infrastructure/mars/ansible/
ansible-playbook -i inventory.ini copy-config.yml
```

**Restore from backup**:
```bash
cd infrastructure/mars/ansible/
# Latest backup:
ansible-playbook -i inventory.ini restore_remote_data.yml

# Specific backup:
ansible-playbook -i inventory.ini restore_remote_data.yml \
  -e "backup_file=/opt/backups/smartworkx/smartworkx-backup-YYYYMMDDTHHMMSS.tgz"
```

### Docker Service Management

**Local development**:
```bash
cd services/
docker-compose up  # Uses dev overrides automatically
```

**Remote deployment** (Mars):
```bash
# Create context (one-time):
docker context create mars --docker "host=ssh://joris@mars.local"

# Deploy:
docker context use mars
cd services/
docker compose up -d

# View logs:
docker compose logs -f [service-name]

# Switch back:
docker context use default
```

## Important Patterns

### Ansible Docker-Host Role

The shared role at `/infrastructure/ansible/roles/docker-host/` automatically detects Ubuntu vs Debian and configures the correct Docker repository. It uses `{{ ansible_distribution | lower }}` for OS detection.

### Home Assistant Configuration

- **Manual automations**: `services/home-assistant/config/custom_automations/*.yaml` (version controlled)
- **UI automations**: `services/home-assistant/config/automations.yaml` (generated by HA)
- Uses `!include_dir_named` and `!include_dir_merge_list` for organization

### Network Configuration

All services use `network_mode: host` for direct network access. USB devices are mapped by ID (e.g., `/dev/serial/by-id/usb-SMLIGHT_...`).

### Backup Strategy

- **Location**: `/opt/backups/smartworkx/` on remote host
- **Retention**: Last 7 backups
- **Contents**: All service data from `/opt/smartworkx/volumes/`

## Architecture Decision Records

Key decisions documented in `/docs/adr/`:
- 0001: Home Assistant as central controller
- 0002: Zigbee as primary IoT protocol
- 0003: Zigbee2MQTT over ZHA
- 0005: Ubuntu LTS for OS
- 0008: Manual Ansible + Docker (IaC approach)
- 0009: SMLight SLZB-06 Zigbee coordinator
- 0010: WireGuard VPN for remote access

## Git Workflow

- **Current branch**: wireguard
- **Main branch**: master (no branch configured, use master for PRs)
- Continuous deployment to mars on main branch changes

## Device Hardware

**Zigbee Coordinator**: SMLight SLZB-06
- Adapter: zstack, Baudrate: 115200, RTSCTS: false

**Z-Wave Controller**: Generic 0658:0200
- Serial: `/dev/serial/by-id/usb-0658_0200-if00`
