---
- hosts: opencloud
  become: true
  become_method: sudo
  become_user: root
  tasks:
    - name: Ensure .ssh directory exists for root
      file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Check if SSH key for storagebox exists
      stat:
        path: /root/.ssh/id_rsa_storagebox
      register: ssh_key_stat

    - name: Generate SSH key for Hetzner Storage Box
      command: ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa_storagebox -N "" -C "jupiter-backup"
      when: not ssh_key_stat.stat.exists

    - name: Read public key
      slurp:
        src: /root/.ssh/id_rsa_storagebox.pub
      register: public_key

    - name: Display public key for manual upload
      debug:
        msg: |
          ========================================
          SSH Public Key for Hetzner Storage Box:
          ========================================
          {{ public_key.content | b64decode }}
          ========================================
          Please add this key to your Hetzner Storage Box:
          1. Go to https://robot.hetzner.com/storage
          2. Click on u524921
          3. Enable SSH support
          4. Add the above public key
          ========================================

    - name: Ensure rclone config directory exists
      file:
        path: /root/.config/rclone
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Copy rclone configuration
      copy:
        src: ../backup/rclone.conf
        dest: /root/.config/rclone/rclone.conf
        mode: '0600'
        owner: root
        group: root

    - name: Copy backup script
      copy:
        src: ../backup/opencloud-backup.sh
        dest: /usr/local/bin/opencloud-backup.sh
        mode: '0755'
        owner: root
        group: root

    - name: Copy systemd service file
      copy:
        src: ../backup/opencloud-backup.service
        dest: /etc/systemd/system/opencloud-backup.service
        mode: '0644'
        owner: root
        group: root

    - name: Copy systemd timer file
      copy:
        src: ../backup/opencloud-backup.timer
        dest: /etc/systemd/system/opencloud-backup.timer
        mode: '0644'
        owner: root
        group: root

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start backup timer
      systemd:
        name: opencloud-backup.timer
        enabled: yes
        state: started

    - name: Display timer status
      command: systemctl status opencloud-backup.timer
      register: timer_status
      changed_when: false

    - name: Show timer status
      debug:
        msg: "{{ timer_status.stdout_lines }}"

    - name: Display next scheduled run
      command: systemctl list-timers opencloud-backup.timer
      register: next_run
      changed_when: false

    - name: Show next scheduled run
      debug:
        msg: "{{ next_run.stdout_lines }}"
